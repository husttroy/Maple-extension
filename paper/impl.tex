\section{Implementation}
\label{sec:implementation}

This section describes the implementation details of {\tool}. Figure~\ref{fig:arch} shows the architecture of {\tool}.  When a user loads a Stack Overflow page in the Chrome browser, the Chrome extension extracts code snippets within {\ttt <code>} tags in answer posts, and sends them to the back-end server in a {\ttt JSON} message. The back end then detects API usage violations in a snippet and synthesizes violation descriptions and fixes. For each misused method call in a snippet, the Chrome extension generates a pop-up window using the Bootstrap popover plug-in\footnote{\url{https://www.w3schools.com/bootstrap/bootstrap_popover.asp}} to visualize the violation information received from the server.


\begin{table*}[!th]
\centering
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|l|l|}
\hline
\multicolumn{1}{|c|}{\sf Violation Type}    & \multicolumn{1}{c|}{\sf Description Template}                                                                                                  & \multicolumn{1}{c|}{\sf Example Warning Message}                                                                                                  \\ \hline
Missing/Incorrect Order of API calls & You may want to call {\bf \textless?\textgreater} {\bf \textless before/after\textgreater} calling {\bf \textless?\textgreater}                   & \begin{tabular}[c]{@{}l@{}}You may want to call {\ttt TypedArray.recycle()} after calling\\ {\ttt TypedArray.getString()}.  [\colorbox{lightgray}{\href{https://stackoverflow.com/questions/35784171}{35784171}}]\end{tabular}                                    \\ \hline
Missing Control Constructs              & You may want to call the API method {\bf \textless?\textgreater} in {\bf \textless?\textgreater}                           & \begin{tabular}[c]{@{}l@{}}You may want to call {\ttt Cursor.close()} in a finally block. [\colorbox{lightgray}{\href{https://stackoverflow.com/questions/31427468}{31427468}}]\end{tabular}                                                            \\ \hline
Missing Try-Catch                       & \begin{tabular}[c]{@{}l@{}} You may want to handle the potential {\bf \textless?\textgreater} exception thrown\\ by {\bf \textless?\textgreater} using a try-catch block\end{tabular} & \begin{tabular}[c]{@{}l@{}}You may want to handle the potential {\ttt SQLException} thrown by\\ {\ttt PreparedStatement.setString()} using a try-catch block. [\colorbox{lightgray}{\href{https://stackoverflow.com/questions/11183042}{11183042}}]\end{tabular} \\ \hline
Incorrect Guard Conditions              & You may want to check whether {\bf \textless?\textgreater} is true before calling {\bf \textless?\textgreater}                 & You may want to check whether {\ttt iterator.hasNext()} is true. [\colorbox{lightgray}{\href{https://stackoverflow.com/questions/25789601}{25789601}}]                                                          \\ \hline
\end{tabular}
}
\caption{Description templates for different types of API usage violations. {\textless?\textgreater} and {\textless before/after\textgreater} are instantiated based on API usage violations and correct patterns. The digits in the last column are the Stack Overflow post ids where each example warning message is reported.}
\label{tab:template}
\end{table*}

{\bf API Usage Pattern Dataset.} {\tool}'s dataset of API usage patterns includes 180 patterns of 100 popular Java API methods in Stack Overflow. These patterns are learned from 380K GitHub repositories and are represented as API call sequences with surrounding control constructs. Each API call in a sequence is also annotated with the argument types and guard conditions. For example, one pattern, {\ttt loop \{; get(int)@arg0$<$rcv.size(); \}}, checks if the index is out of bounds when calling the {\ttt get} method on an {\ttt ArrayList} object. The pattern format and the mining algorithm are described in~\cite{zhang2018code}. The current dataset can be extended with API usage patterns learned from other mining techniques~\cite{gruska2010learning, wang2013mining, zhong2009mapo, Nguyen09}. 

{\bf API Misuse Detection.} The back end first extracts API call sequences from the snippets sent by the Chrome extension using a partial program analysis framework that handles incomplete snippets with no class or method headers~\cite{subramanian2014live}. {\tool} then searches its pattern database for the API calls present in each API call sequence. Given an API call sequence and an API usage pattern, it checks whether (1)  the pattern is a subsequence of the API call sequence, and (2) the guard condition of each API call in the sequence implies the guard of the corresponding API call in the pattern. {\tool} uses a SMT solver, Z3~\cite{de2008z3}, to check whether one guard condition implies another. For a Stack Overflow post with multiple method-level code snippets, {\tool} inlines invoked methods before extracting the call sequence in order to emulate a lightweight inter-procedural analysis. {\tool} is capable of detecting three types of API usage violations---{\em missing control constructs}, {\em missing or incorrect order of API call}, and {\em incorrect precondition}.

%When {\soa} encounters a new API that does not exist in its database, it automatically issues another mining request and expands the database with the new patterns it finds. Specifically, {\soa} utilizes a distributed software mining infrastructure, Boa \todo{cite} to traverse the abstract syntax trees (ASTs) of 7 million Java projects, collected September 2015 from GitHub. For every AST method, {\soa} checks if it is from the API of interest. If it is, {\soa} translates the code snippet into a structured call sequence. From these call sequences, {\soa} finds a common subsequence which is the required pattern for that API method, and this is added to the database.
%\todo{It is not necessary to describe how we wrap the data and communicate with the front-end. Please shorten this paragraph.}

%{\bf Popup Generation.} Using the data from the server's JSON message, the plug-in searches the identified code snippet for the API call in question, highlights it, and generates a Bootstrap popover on it, as seen in Figure~\ref{fig:features}. The popover is populated with a violation message describing the pattern being violated and including the GitHub support for the required pattern, in terms of number of supporting projects as well as three links to relevant GitHub pages using that pattern correctly. The plug-in generates one popover for each API call, and generates pages of the popover for each different pattern being violated by that call.

{\bf Warning message generation.} Given an API usage violation and the correct pattern, {\tool} generates a short warning message that describes the violation in natural language. Table~\ref{tab:template} shows the description templates for different types of API usage violations. In each template, {\textless?\textgreater} is instantiated with the corresponding API calls or control constructs based on the detected API usage violation and the correct pattern. {\textless before/after\textgreater} is instantiated based on the relative order of the two API calls in the correct pattern. Note that though {\em missing try-catch} is a subtype of {\em missing control construct}, we design a specialized template to elaborate the exception type for a missing-try-catch violation. 

{\bf Fix suggestion.} {\tool} further suggests the correct way of using an API method by synthesizing a readable code snippet based on the context of the original Stack Overflow post. {\tool} first matches each API call or control construct in the correct pattern with the method call sequence extracted from the original Stack Overflow post. If an API call or a control construct is matched with a code element in the original post, {\tool} directly copies the corresponding code element from the original post to the synthesized snippet. Otherwise, {\tool} generates a method call statement and names the receiver and arguments based on their types. For example, if the receiver type of an unmatched API call (i.e., a {\em missing-API-call} violation) is {\ttt File}, {\tool} names the receiver variable as {\ttt file}, the lower case of the receiver type. By contextualizing the correct pattern based on the original Stack Overflow post, {\tool} can reduce the mind gap when a programmer switches between the original post and the corrected snippet.

%{\bf GitHub Example Alteration.} When the user clicks on a provided GitHub example in the popup, the plug-in's main script writes the name of the method call associated with that link to a shared storage space for the Chrome extension, using the {\tt chrome.storage} API. The script highlights the entire method and scrolls the view down so the user is easily able to find it, as seen in Figure~\ref{fig:github_examples}.